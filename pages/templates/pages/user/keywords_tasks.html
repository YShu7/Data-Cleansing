{% extends "pages/user/base.html" %}

{% block content %}
    <style>
        mark {
            background-color: white;
            color: black;
        }

        mark:hover {
            background-color: #b3d7ff;
        }

        .highlight {
            background-color: #7abaff;
        }
    </style>
    {% include "pages/user/partial/progress_bar.html" with num_done=num_done num_doing=num_doing num_total=num_total %}

    {% if page_obj %}
        <br/>

        <div id="taskList">
            <table type="table" class="table">
                <thead class="thead-light">
                <tr>
                    <th scope="col" width="5%">ID</th>
                    <th scope="col" width="30%">Question</th>
                    <th scope="col" width="40%">Answer</th>
                    <th scope="col" width="25%"></th>
                </tr>
                </thead>
                <tbody id="voting_tasks">
                <input id="door" type="hidden" value="1">
                {% for question in page_obj %}
                    <form action="{% url 'keywords' question.id %}" method="post">
                        {% csrf_token %}
                        <tr>
                            <th scope="row">{{ question.id }}</th>
                            <td id="qns_keywords_td">
                                <input class="keyword" name="qns_keywords" type="hidden">
                                <div class="text">{{ question.data_ptr.title }}</div>

                            <td id="ans_keywords_td">
                                <input class="keyword" name="ans_keywords" type="hidden">
                                <div class="text">{{ question.answer_text }}</div>
                            </td>
                            <td>
                                <input type="hidden">
                                <button id="vote_{{ question.id }}" value="0" type="submit"
                                        class="submit btn btn-outline-primary btn-sm btn-block">
                                    Submit
                                </button>
                            </td>
                        </tr>
                    </form>
                {% endfor %}
                </tbody>
            </table>
            {% include "pages/partial/page_footer.html" with page_obj=page_obj  num_done=num_done %}
        </div>

        <script>
            $(document).ready(function () {
                $(".text").on('mouseup', function () {
                    var selectedText = getSelectionText();
                    if (selectedText == "") return;
                    var selectedTextRegExp = new RegExp(selectedText,"g");
                    var text = $(this).text().replace(selectedTextRegExp, "<mark class='highlight'>" + selectedText + "</mark>");
                    $(this).html(text);

                    updateKeyword($(this), selectedText);
                });
                window.onbeforeunload = function (event) {
                    if ($("#door").val() == 0) {
                        return confirm("Confirm refresh");
                    }
                };
                function getSelectionText() {
                    var text = "";
                    if (window.getSelection) {
                        text = window.getSelection().toString();
                    } else if (document.selection && document.selection.type != "Control") {
                        text = document.selection.createRange().text;
                    }
                    return text;
                }
                function updateKeyword(ele, keyword) {
                    $("#door").val(0);
                    var input_ele = ele.siblings('.keyword');
                    var old_val = input_ele.val();

                    if (ele.hasClass("highlight")) {
                        input_ele.val(old_val + keyword + ",");
                    } else {
                        input_ele.val(old_val.replace(keyword + ",", ""));
                    }
                }
            });
        </script>
    {% else %}
        <br/>
        <div class="alert alert-success" role="alert">
            You have complete all keyword selection tasks.
        </div>
    {% endif %}
{% endblock %}